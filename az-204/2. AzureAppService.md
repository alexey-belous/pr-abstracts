# Azure App Service
Responsibilities:
- On premises - all is your resp
- Infrastructure as a Service (IaaS) - like VM, no physical resp, starting from OS level is your resp
- Platform as a Service (PaaS) - only data and runtime are resp.
- SaaS - users and data.
  
**App service** - abstraction over VM.

ACU - computation performance index

## App Service plans
Plan determines:
- Operating System (Windows, Linux)
- Region (West US, East US, etc.)
- Number of VM instances
- Size of VM instances (Small, Medium, Large)
- Pricing tier (Free, Shared, Basic, Standard, Premium, PremiumV2, PremiumV3, Isolated, IsolatedV2)

App also has **pricing tier**, determines what features will be included:
- Shared compute: Free and Shared, the two base tiers, runs an app on the same Azure VM as other App Service apps, including apps of other customers. These tiers allocate CPU quotas to each app that runs on the shared resources, and the resources can't scale out.
- Dedicated compute: The Basic, Standard, Premium, PremiumV2, and PremiumV3 tiers run apps on dedicated Azure VMs. Only apps in the same App Service plan share the same compute resources. The higher the tier, the more VM instances are available to you for scale-out.
- Isolated: The Isolated and IsolatedV2 tiers run dedicated Azure VMs on dedicated Azure Virtual Networks. It provides network isolation on top of compute isolation to your apps. It provides the maximum scale-out capabilities.

## Auth
Build-in auth:
- Azure App Service allows you to integrate various auth capabilities into your web app or API without implementing them yourself.
- It’s built directly into the platform and doesn’t require any particular language, SDK, security expertise, or code.
- You can integrate with multiple login providers. For example, Microsoft Entra ID, Facebook, Google, Twitter.

## Networking
By default app is accessible by internet. Apps cannot be connected directly to the customer network. Instead, inbound and outbound features can be added.
Inbound:
- App-assigned address	
- Access restrictions
- Service endpoints
- Private endpoints

Outbound: 
- Hybrid Connections
- Gateway-required virtual network integration
- Virtual network integration

## Configuration: 
App settings can be overwritten in app config section. Connection strings stored separately encrypted.
App configuration allows to set stack settings, platform settings (bitness, websocket, remote debugging etc).

## Diagnostic
App Service logs can be enabled and downloaded through FTP.
Diagnostic settings - aggregation of several types of logs e.g. into Log analytics workspace. Can be viewed in **Logs** section of the Az App.
KQL Kusto query language - querying logs.

### Types of logging:
- App logging - (win/lin) - messages generated by the code;
- Web server logging - (win) - HTTP request data;
- Detailed error logging - (win) - html error pages, shown to client;
- Failed request tracing - (win) - trace of IIS components handlers of the request; 
- Deployment logging - (win/lin)

Log stream - streaming in real time.

## Certificates
- Free App Service managed cert - free of charge, auto renewal;
- Purchase App Service cert - auto renewal, custom DNS?
- Import cert from Key Vault
- Upload a private cert
- Upload a public cert

## Scaling:
Scaling up/down - change plan
Scaling in/out - replication with Azure autobalancer. Manual scale + autoscale based on schedule or metric (CPU, users in line). Rules for scaling up and down are needed.

## Local cache

- The content is shared across multiple virtual machine (VM) instances of the app.
- The content is durable and can be modified by running apps.
- Log files and diagnostic data files are available under the same shared content folder.
- Publishing new content directly updates the content folder. You can immediately view the same content through the SCM website and the running app.

`D:\home` - is a location of the cache.
`WEBSITE_LOCAL_CACHE_OPTION=Always` enables local cache.
`WEBSITE_LOCAL_CACHE_SIZEINMB` - size of cache (default is 1 GB, max is 2 GB).


## Deployment:
Azure App service may has deployment slots, that may be switched (standard tier or better).

Deployment slots - Several versions of the app - staging, prod, dev etc.

Process:
1. Swap config from SOURCE to TARGET
2. Restart TARGET
3. Check TARGET
4. Clear cache of TARGET
5. Pre-warm TARGET
6. Check TARGET
7. Switch routing rules from SOURCE to TARGET
8. Preform the same operation against SOURCE slot

Deployment slot settings may be swapped as well (slot-specific app settings, CD settings, auth settings).

Swapped settings: general settings, app settings, handlers mappings, pub certs, WebJobs content, Hybrid connections, Az CDN, Service endpoints, Path mappings.

Not swapped settings: publishing endpoints, custom domain names, non-public certs, scale settings, WebJobs schedulers, IP restrictions, Always on, Diagnostic log settings, CORS, Virtual network integration, Managed identities, settings with suffix `_EXTENSION_VERSION`.

There are manual swap, swap with preview and auto swap.
Auto swap is for CI/CD.
Custom warm-up is for warming up the app before swap.
There's an option to send a portion of traffic to another slot.

### Create in PS
```ps
get-command *AzWebApp* # shows list of commands that match the pattern

New-AzResourceGroup -Location 'EastUS' -Name 'pswebapp' -Force -Tag value1

New-AzAppServicePlan -Name 'NewAppPlan' -Location 'EastUS' -ResourceGroupName 'pswebapp' -Tier Free

New-AzWebApp -ResourceGroupName 'pswebapp' -Name 'NewWebApp' -Location 'EastUS' -AppServicePlan 'pswebapp'
```

### Create in CLI
```bash
az group create --name cliwebapp --location eastus
az appservice plan create -g cliwebapp -n mynewasp234
az webapp create -g cliwebapp -n mynewwebapp2 -p mynewasp234
```


```bash
mkdir newwebapp
cd newwebapp

git clone https://any-repo...

az webapp up --location eastus --name newapp123 --html # do all the same as in previous example with deploying working directory into the app
```

### Debugging
Console - console inside web app
Kudu - advanced diagnostic tool